<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Raster Time-Series</title>
<meta name="description" content="Efficiently analyze raster upon raster.">
<link rel="canonical" href="http://cyberhelp.sesync.org/raster-time-series-alaska-lesson/course/archive.html">
<link rel="stylesheet" href="https://cdn.rawgit.com/sesync-ci/lesson-style/v1.3/docs/css/default.css">
<link rel="stylesheet" href="https://cdn.rawgit.com/sesync-ci/lesson-style/v1.3/docs/css/static.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script>

  </head>
  <body>
    <div class="page-content">
      <div class="wrapper">
        
        
<h1 style="text-transform: none;" id="raster-time-series">Raster Time-Series</h1>

<h2 style="text-transform: none;" id="wildfire-in-alaska">Wildfire in Alaska</h2>

<p>Lesson 4 with <em>Ian Carroll</em></p>

<h2 id="contents">Contents</h2>

<ul>
  <li><a href="#/slides/intro">Objectives for this Lesson</a></li>
  <li><a href="#/slides/stack">Raster upon Raster</a></li>
  <li><a href="#/slides/brick">Raster Time Series</a></li>
  <li><a href="#/slides/pca">Eliminating Time</a></li>
  <li><a href="#/slides/conclude">Summary</a></li>
</ul>

<hr />

<p><a name="/slides/intro"></a></p>

<h2 id="objectives-for-this-lesson">Objectives for this Lesson</h2>

<ul>
  <li>Observe characteristics of wildfire in remote sensing data</li>
  <li>Find “unusual” pixels in time-series of raster data</li>
</ul>

<h2 id="specific-achievements">Specific Achievements</h2>

<ul>
  <li>Distinguish “stacks” from “bricks”</li>
  <li>Use MODIS derived NDVI</li>
  <li>Execute efficient raster calculations</li>
  <li>Perform PCA on “bricks”</li>
</ul>

<h2 id="import-clarification">Import Clarification</h2>

<p>Functions from the <a href="" class="rlib">raster</a> package dominate this lesson, so load all
its elements and use them without a pointer back to the library. Import
functions from other packages as needed using the <a href="" class="rlib">modules</a> library,
to make their source clear for training purposes.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span><span class="w">
</span><span class="n">import</span><span class="p">(</span><span class="s1">'magrittr'</span><span class="p">,</span><span class="w"> </span><span class="s1">'%&gt;%'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="ToS"><a href="#/slides/intro">Top of Section</a></p>

<hr />

<p><a name="/slides/stack"></a></p>

<h2 id="raster-upon-raster">Raster upon Raster</h2>

<p>The <a href="" class="rlib">raster</a> library uniformly handles two-dimensional data as a
<code class="highlighter-rouge">RasterLayer</code> object, created with the <code class="highlighter-rouge">raster()</code> function. There are several
cases where raster data has a third dimension.</p>

<ul>
  <li>a multi-band image (e.g. Landsat scenes)</li>
  <li>closely related images (e.g. time series of NDVI values)</li>
  <li>three dimensional data (e.g. GCM products)</li>
</ul>

<p>Any <code class="highlighter-rouge">RasterLayer</code> objects that have the same extent and resolution (i.e. cover
the same space with the same number of rows and columns) can be combined into
one of two container types:</p>

<ul>
  <li>a <code class="highlighter-rouge">RasterStack</code> created with <code class="highlighter-rouge">stack()</code></li>
  <li>a <code class="highlighter-rouge">RasterBrick</code> created with <code class="highlighter-rouge">brick()</code></li>
</ul>

<h2 id="raster-stacks">Raster Stacks</h2>

<p>The layers of a “stack” can refer to data from separate files, or even a mix of
data on disk and data in memory.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_yrly</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.glob</span><span class="p">(</span><span class="s1">'data/r_ndvi_*.tif'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_yrly</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "data/r_ndvi_2001_2009_filling6__STA_year2_Amplitude0.tif"
[2] "data/r_ndvi_2001_2009_filling6__STA_year9_Amplitude0.tif"
</code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stack</span><span class="p">(</span><span class="n">ndvi_yrly</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w">
  </span><span class="s1">'Avg NDVI 2002'</span><span class="p">,</span><span class="w">
  </span><span class="s1">'Avg NDVI 2009'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4" /></p>

<p>The data source for the first layer is the first file in the list. Note that the
CRS is missing: it is quite possible to stack files with different
projections. They only have to share a common extent and resolution.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class       : RasterLayer 
dimensions  : 1951, 2441, 4762391  (nrow, ncol, ncell)
resolution  : 1000.045, 999.9567  (x, y)
extent      : -930708.7, 1510401, 454027.3, 2404943  (xmin, xmax, ymin, ymax)
coord. ref. : NA 
data source : /data/r_ndvi_2001_2009_filling6__STA_year2_Amplitude0.tif 
names       : Avg.NDVI.2002 
values      : -0.3, 0.8713216  (min, max)
</code></pre></div></div>

<p>Set the CRS using the <a href="http://spatialreference.org/ref/epsg/nad83-alaska-albers/">EPSG code
3338</a> for an Albers
Equal Area projection of Alaska using the NAD38 datum.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">crs</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'+init=epsg:3338'</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">raster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class       : RasterLayer 
dimensions  : 1951, 2441, 4762391  (nrow, ncol, ncell)
resolution  : 1000.045, 999.9567  (x, y)
extent      : -930708.7, 1510401, 454027.3, 2404943  (xmin, xmax, ymin, ymax)
coord. ref. : +init=epsg:3338 +proj=aea +lat_1=55 +lat_2=65 +lat_0=50 +lon_0=-154 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
</code></pre></div></div>

<p>The <code class="highlighter-rouge">ndvi</code> object only takes up a tiny amount of memory. The pixel values
take up much more space on disk, as you can see in the file browser.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">print</span><span class="p">(</span><span class="n">object.size</span><span class="p">(</span><span class="n">ndvi</span><span class="p">),</span><span class="w">
  </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'KB'</span><span class="p">,</span><span class="w">
  </span><span class="n">standard</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'SI'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>29.4 kB
</code></pre></div></div>

<p>Why so small? The <code class="highlighter-rouge">ndvi</code> object is only metadata and a pointer to where the
pixel values are saved on disk.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inMemory</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] FALSE
</code></pre></div></div>

<p class="notes">Whereas <code class="highlighter-rouge">read.csv()</code> would load the named file into memory, the <a href="" class="rlib">raster</a> library handles files like a database where
possible. The values can be accessed, to make those plots for example, but are
not held in memory. This is the key to working with deep stacks of large rasters.</p>

<h2 id="wildfires-in-alaska">Wildfires in Alaska</h2>

<p>Many and massive wildfires burned in Alaska and the Yukon between 2001 and 2009.
Three large fires that burned during this period (their locations are in a
shapefile) occured within boreal forest areas of central Alaska.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">import</span><span class="p">(</span><span class="s1">'sf'</span><span class="p">,</span><span class="w"> </span><span class="s1">'read_sf'</span><span class="p">,</span><span class="w"> </span><span class="s1">'st_geometry'</span><span class="p">,</span><span class="w">
  </span><span class="s1">'st_bbox'</span><span class="p">)</span><span class="w">
</span><span class="n">scar</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read_sf</span><span class="p">(</span><span class="w">
  </span><span class="s1">'data/OVERLAY_ID_83_399_144_TEST_BURNT_83_144_399_reclassed'</span><span class="p">,</span><span class="w">
  </span><span class="n">crs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3338</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10" /></p>

<p>For faster processing in this lesson, crop the NDVI imagery to the smaller extent of the shapefile.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">burn_bbox</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">extent</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w">
</span><span class="n">ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="n">burn_bbox</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[[</span><span class="m">1</span><span class="p">]],</span><span class="w"> </span><span class="n">ext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">burn_bbox</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-12-1.png" alt="plot of chunk unnamed-chunk-12" /></p>

<p>Notice, however, that the NDVI values are now stored in memory. That’s okay for this part of the lesson; we’ll see the alternative shortly.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">inMemory</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] TRUE
</code></pre></div></div>

<h2 id="pixel-change">Pixel Change</h2>

<p>Use element-wise subtration to give a difference raster, where negative values
indicate a higher NDVI in 2002, or a decrease in NDVI from 2002 to 2009.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">diff_ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ndvi</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ndvi</span><span class="p">[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'Difference'</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-15-1.png" alt="plot of chunk unnamed-chunk-15" /></p>

<p>The histogram shows clearly that change in NDVI within this corner of Alaska clusters around two modes.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hist</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-16-1.png" alt="plot of chunk unnamed-chunk-16" /></p>

<p>One way to “classify” pixels as potentially affected by wildfire is to threshold
the differrence. Pixels below “-0.1” mostly belong to the smaller mode, and may
represent impacts of wildfire.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-0.1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-17-1.png" alt="plot of chunk unnamed-chunk-17" /></p>

<p>The threshold value could also be defined in terms of the variability among
pixels.</p>

<p class="notes">Centering and scaling the pixel values requires computation of their
mean and standard variation. The <code class="highlighter-rouge">cellStats</code> function efficiently applies a few
common functions across large rasters, regardless of whether the values are in
memory or on disk.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">diff_ndvi_mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cellStats</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="p">,</span><span class="w"> </span><span class="s1">'mean'</span><span class="p">)</span><span class="w">
</span><span class="n">diff_ndvi_sd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cellStats</span><span class="p">(</span><span class="n">diff_ndvi</span><span class="p">,</span><span class="w"> </span><span class="s1">'sd'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="notes">Mathematical operations with rasters and scalars work as expected; scalar
values are repeated for each cell in the array.</p>

<p>The difference threshold of “-0.1” appears roughly equivalent to a threshold of
1 standard deviation below zero.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">diff_ndvi_stdz</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">diff_ndvi</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">diff_ndvi_mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">diff_ndvi_sd</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">diff_ndvi_stdz</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'Standardized Difference'</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hist</span><span class="p">(</span><span class="n">diff_ndvi_stdz</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-20-1.png" alt="plot of chunk unnamed-chunk-20" /></p>

<p>Standardizing the pixel values does not change the overal result.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">diff_ndvi_stdz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/stack/unnamed-chunk-21-1.png" alt="plot of chunk unnamed-chunk-21" /></p>

<p class="ToS"><a href="#/slides/stack">Top of Section</a></p>

<hr />

<p><a name="/slides/brick"></a></p>

<h2 id="raster-time-series">Raster Time Series</h2>

<p>Take a closer look at NDVI using products covering 16 day periods in 2005. These
images are stored as separate files on disk, all having the same extent and
resolution.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_16day</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sys.glob</span><span class="p">(</span><span class="w">
  </span><span class="s1">'data/NDVI_alaska_2005/*.tif'</span><span class="p">)</span><span class="w">
</span><span class="n">ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">stack</span><span class="p">(</span><span class="n">ndvi_16day</span><span class="p">)</span><span class="w">
</span><span class="n">crs</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'+init=epsg:3338'</span><span class="w">
</span></code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">dates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="w">
  </span><span class="n">sub</span><span class="p">(</span><span class="s1">'alaska_NDVI_'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)),</span><span class="w">
  </span><span class="s1">'%Y_%m_%d'</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">format</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span><span class="w"> </span><span class="s1">'%b %d %Y'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">subset</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/brick/unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3" /></p>

<h2 id="raster-bricks">Raster Bricks</h2>

<p>A <code class="highlighter-rouge">RasterBrick</code> representation of tightly integrated raster layers, such as a
time series of remote sensing data from sequential overflights, has advantages
for speed but limitations on flexibility.</p>

<p class="notes">A <code class="highlighter-rouge">RasterStack</code> is more flexible because it can mix values stored on disk with those in memory. Adding a layer of in-memory values to a RasterBrick causes the entire brick to be loaded into memory, which may not be possible given the available memory.</p>

<p>For training purposes, again crop the NDVI data to the bounding box of the wildfires shapefile. But this time, avoid reading the values into memory.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="n">burn_bbox</span><span class="p">,</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'results/crop_alask_ndvi.grd'</span><span class="p">,</span><span class="w">
  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Notice that <code class="highlighter-rouge">crop</code> creates a <code class="highlighter-rouge">RasterBrick</code>. In fact, we have been working with a <code class="highlighter-rouge">RasterBrick</code> in memory since first using <code class="highlighter-rouge">crop</code>.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class       : RasterBrick 
dimensions  : 74, 151, 11174, 23  (nrow, ncol, ncell, nlayers)
resolution  : 1000.045, 999.9566  (x, y)
extent      : 68336.16, 219342.9, 1772970, 1846967  (xmin, xmax, ymin, ymax)
coord. ref. : +init=epsg:3338 +proj=aea +lat_1=55 +lat_2=65 +lat_0=50 +lon_0=-154 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0 
data source : /home/Ian/training/raster-time-series-alaska-lesson/results/crop_alask_ndvi.grd 
names       : Jan.01.2005, Jan.17.2005, Feb.02.2005, Feb.18.2005, Mar.06.2005, Mar.22.2005, Apr.07.2005, Apr.23.2005, May.09.2005, May.25.2005, Jun.10.2005, Jun.26.2005, Jul.12.2005, Jul.28.2005, Aug.13.2005, ... 
min values  :    -0.19518,    -0.20000,    -0.19900,    -0.18050,    -0.12120,    -0.09540,    -0.03910,    -0.11290,    -0.09390,    -0.15520,    -0.18400,    -0.16780,    -0.18000,    -0.17200,    -0.18600, ... 
max values  :   0.3337000,   0.3633000,   0.4949000,   0.3514000,   0.4898000,   0.7274000,   0.6268000,   0.5879000,   0.9076000,   0.9190000,   0.8807000,   0.9625000,   0.8810000,   0.9244000,   0.9493000, ... 
</code></pre></div></div>

<h2 id="so-many-data">So many data</h2>

<p>The immediate challenge is trying to represent the data in ways we can explore
and interpret the characteristics of wildfire visible by remote sensing.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">animate</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="n">pause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/ndvi_animation.gif" alt="plot of ndvi_animation" /></p>

<h2 id="pixel-time-series">Pixel Time Series</h2>

<p>Verify that something happened very abruptly (fire!?) by plotting the time
series at pixels corresponding to locations with dramatic NDVI variation in the
layer from Aug 13, 2005.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">idx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">match</span><span class="p">(</span><span class="s1">'Aug.13.2005'</span><span class="p">,</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[[</span><span class="n">idx</span><span class="p">]])</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/brick/unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8" /></p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">click</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[[</span><span class="n">idx</span><span class="p">]],</span><span class="w"> </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">pixel</span><span class="w">
</span></code></pre></div></div>

<p>“Hard code” these pixel values into your worksheet</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2813</span><span class="p">,</span><span class="w"> </span><span class="m">3720</span><span class="p">,</span><span class="w"> </span><span class="m">2823</span><span class="p">,</span><span class="w"> </span><span class="m">4195</span><span class="p">,</span><span class="w"> </span><span class="m">9910</span><span class="p">)</span><span class="w">
</span><span class="n">scar_pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pixel</span><span class="p">)),</span><span class="w">
  </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">dates</span><span class="p">)),</span><span class="w">
  </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'burn scar?'</span><span class="p">,</span><span class="w">
  </span><span class="n">NDVI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[</span><span class="n">pixel</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Repeat the selection with <code class="highlighter-rouge">click</code> for “normal” looking pixels.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1710</span><span class="p">,</span><span class="w"> </span><span class="m">4736</span><span class="p">,</span><span class="w"> </span><span class="m">7374</span><span class="p">,</span><span class="w"> </span><span class="m">1957</span><span class="p">,</span><span class="w"> </span><span class="m">750</span><span class="p">)</span><span class="w">
</span><span class="n">normal_pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">pixel</span><span class="p">)),</span><span class="w">
  </span><span class="n">cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">dates</span><span class="p">)),</span><span class="w">
  </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'normal'</span><span class="p">,</span><span class="w">
  </span><span class="n">NDVI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">ndvi</span><span class="p">[</span><span class="n">pixel</span><span class="p">]))</span><span class="w">
</span></code></pre></div></div>

<p>Join your haphazard samples together for comparison as time series.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">import</span><span class="p">(</span><span class="s1">'ggplot2'</span><span class="p">,</span><span class="w"> </span><span class="s1">'ggplot'</span><span class="p">,</span><span class="w"> </span><span class="s1">'aes'</span><span class="p">,</span><span class="w">
  </span><span class="s1">'geom_line'</span><span class="p">)</span><span class="w">
</span><span class="n">pixel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">normal_pixel</span><span class="p">,</span><span class="w"> </span><span class="n">scar_pixel</span><span class="p">)</span><span class="w">
</span><span class="n">ggplot</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span><span class="w">
  </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NDVI</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Type</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/brick/unnamed-chunk-12-1.png" alt="plot of chunk unnamed-chunk-12" /></p>

<h2 id="zonal-averages">Zonal Averages</h2>

<p>Cannot very well analyze the time series for every pixel, so we have to reduce
the dimensionality of the data. One way is to summarize it by “zones” defined by
another spatial data source.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">?</span><span class="n">zonal</span><span class="w">
</span></code></pre></div></div>

<p class="notes">Currently we have raster data (<code class="highlighter-rouge">ndvi</code>) and vector data (<code class="highlighter-rouge">scar</code>). In order to
aggregate by polygon, we have to join these two datasets. There are two
approaches. 1) Treat the raster data as POINT geometries in a table and perform
a spatial join to the table with POLYGON geometries. 2) Turn the polygons into a
raster and summarize the raster masked for each polygon. Let’s persue option 2, but take a shortcut due to the presence of invalid geometries in the shapefile.</p>

<p>Typically we could convert simple features to raster with the <code class="highlighter-rouge">rasterize</code> function, but not all geometries are well defined.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Does not work, due to invalid geometries.</span><span class="w">
</span><span class="n">scar_geom</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="s1">'Spatial'</span><span class="p">)</span><span class="w">
</span><span class="n">scar_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rasterize</span><span class="p">(</span><span class="n">scar_geom</span><span class="p">,</span><span class="w"> </span><span class="n">ndvi</span><span class="p">,</span><span class="w">
  </span><span class="n">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'results/scar.grd'</span><span class="p">,</span><span class="w">
  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sf</span><span class="o">::</span><span class="n">st_is_valid</span><span class="p">(</span><span class="n">scar</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning in evalq((function (..., call. = TRUE, immediate. = FALSE,
noBreaks. = FALSE, : Self-intersection at or near point 209342.45385742188
1824967.8842773438
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning in evalq((function (..., call. = TRUE, immediate. = FALSE,
noBreaks. = FALSE, : Self-intersection at or near point 181341.19775390625
1775970.0076904297
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Warning in evalq((function (..., call. = TRUE, immediate. = FALSE,
noBreaks. = FALSE, : Nested shells at or near point 75336.442504882812
1815968.2742919922
</code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Self-intersection[209342.453857422 1824967.88427734]"
[2] "Self-intersection[181341.197753906 1775970.00769043]"
[3] "Nested shells[75336.4425048828 1815968.27429199]"    
</code></pre></div></div>

<p>Fortunately, we have the rasterized version from another source.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">scar_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="w">
  </span><span class="s1">'data/r_OVERLAY_ID_83_399_144_TEST_BURNT_83_144_399_reclassed.tif'</span><span class="p">)</span><span class="w">
</span><span class="n">crs</span><span class="p">(</span><span class="n">scar_zone</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'+init=epsg:3338'</span><span class="w">
</span><span class="n">scar_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crop</span><span class="p">(</span><span class="n">scar_zone</span><span class="p">,</span><span class="w"> </span><span class="n">ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">zonal</code> function calculates <code class="highlighter-rouge">fun</code> over each zone</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">scar_ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">zonal</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w">
  </span><span class="n">scar_zone</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mean"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Rearrange the data for vizualization as a time series.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="n">scar_ndvi</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="p">])</span><span class="w">
</span><span class="n">scar_ndvi</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">scar_ndvi</span><span class="p">[,</span><span class="w"> </span><span class="m">-1</span><span class="p">]</span><span class="w">
</span><span class="n">scar_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nrow</span><span class="p">(</span><span class="n">scar_ndvi</span><span class="p">)),</span><span class="w">
  </span><span class="n">Zone</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">dates</span><span class="p">)),</span><span class="w">
  </span><span class="n">NDVI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">scar_ndvi</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>What appears to be the most pronounced signal in this view is an early loss of greenness compared to the background NDVI.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">scar_zone</span><span class="p">,</span><span class="w">
  </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NDVI</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zone</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/brick/unnamed-chunk-19-1.png" alt="plot of chunk unnamed-chunk-19" /></p>

<p>Zonal statistics</p>

<ul>
  <li>provide a very clean reduction of raster time-series for easy vizualization</li>
  <li>require pre-defined zones!</li>
</ul>

<p class="ToS"><a href="#/slides/brick">Top of Section</a></p>

<hr />

<p><a name="/slides/pca"></a></p>

<h2 id="eliminating-time">Eliminating Time</h2>

<p>Because changes to NDVI at each pixel follow a similar pattern over the course of a year, the slices are highly correlated. Consider representing the NDVI values as a simple matrix with</p>

<ul>
  <li>each time slice as a variable</li>
  <li>each pixel as an observation</li>
</ul>

<p class="notes">PCA is a technique for reducing dimensionality of a dataset based on correlation
between variables. The method proceeds either by eigenvalue decomposition of a
covariance matrix or singular-value decomposition of the entire dataset.</p>

<p>To perform PCA on raster data, it’s efficient to use specialized tools that calculate a covariance matrix without reading in that big data matrix.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_lS</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">layerStats</span><span class="p">(</span><span class="w">
  </span><span class="n">ndvi</span><span class="p">,</span><span class="w"> </span><span class="s1">'cov'</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">ndvi_mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ndvi_lS</span><span class="p">[[</span><span class="s1">'mean'</span><span class="p">]]</span><span class="w">
</span><span class="n">ndvi_cov</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ndvi_lS</span><span class="p">[[</span><span class="s1">'covariance'</span><span class="p">]]</span><span class="w">
</span><span class="n">ndvi_cor</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">cov2cor</span><span class="p">(</span><span class="n">ndvi_cov</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">layerStats</code> function only evaluates standard statistical summaries. The <code class="highlighter-rouge">calc</code> function however can apply user defined functions over or across raster layers.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_std</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">ndvi_cov</span><span class="p">))</span><span class="w">
</span><span class="n">ndvi_stdz</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">calc</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span><span class="w">
  </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ndvi_mean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ndvi_std</span><span class="p">,</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'results/ndvi_stdz.grd'</span><span class="p">,</span><span class="w">
  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Standardizing the data removes the large seasonal swing, but not the correlation between “variables”, i.e. between pixels in different time slices. Only the correlation matters for PCA.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">animate</span><span class="p">(</span><span class="n">ndvi_stdz</span><span class="p">,</span><span class="w"> </span><span class="n">pause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/ndvi_stdz_animation.gif" alt="plot of ndvi_stdz_animation" /></p>

<p>Now, the principal component calculation proceeds using the NDVI correlations,
which is just a 23 by 23 matrix of pairwise correlations between the 23 time
slices. The plot method of the output shows the variance among pixels, not at
each time slice, but on each principal component.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">pca</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">princomp</span><span class="p">(</span><span class="n">covmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ndvi_cor</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">pca</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/pca/unnamed-chunk-5-1.png" alt="plot of chunk unnamed-chunk-5" /></p>

<p>Principal component “loadings” correspond to the weight each time slice
contributes to each component. The first principal component is a more-or-less
equally weighted combination of all time slices, like an average.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">npc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">4</span><span class="w">
</span><span class="n">loading</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="w">
  </span><span class="n">Date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span><span class="w"> </span><span class="n">npc</span><span class="p">),</span><span class="w"> 
  </span><span class="n">PC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factor</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">npc</span><span class="p">,</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">dates</span><span class="p">))),</span><span class="w">
  </span><span class="n">Loading</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">pca</span><span class="o">$</span><span class="n">loadings</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">npc</span><span class="p">])</span><span class="w">
</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ggplot</span><span class="p">(</span><span class="n">loading</span><span class="p">,</span><span class="w"> </span><span class="n">aes</span><span class="p">(</span><span class="w">
  </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Date</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Loading</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PC</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">
  </span><span class="n">geom_line</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/pca/unnamed-chunk-7-1.png" alt="plot of chunk unnamed-chunk-7" /></p>

<p>The principal component scores are a projection of the NDVI values at each time
point onto the components. The calculation is matrix multiplation on the NDVI
time-series, which you may not be able to do in memory. The <a href="" class="rlib">raster</a>
package <code class="highlighter-rouge">predict</code> wrapper carries the PCA output’s <code class="highlighter-rouge">predict</code> method through to
the time series for each pixel.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">pca</span><span class="o">$</span><span class="n">center</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pca</span><span class="o">$</span><span class="n">scale</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">ndvi_scores</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="w">
  </span><span class="n">ndvi_stdz</span><span class="p">,</span><span class="w"> </span><span class="n">pca</span><span class="p">,</span><span class="w">
  </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">npc</span><span class="p">,</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'results/ndvi_scores.grd'</span><span class="p">,</span><span class="w">
  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ndvi_scores</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/pca/unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8" /></p>

<p class="notes">A complication in here is that the <code class="highlighter-rouge">pca</code> object does not know how the original
data were centered, because we didn’t give it the original data. The <code class="highlighter-rouge">predict</code>
function will behave as if we performed PCA on <code class="highlighter-rouge">ndvi_stdz[]</code> if we set the
centering vector to zeros.</p>

<p>The first several principal components account for most of the variance in the
data, so approximate the NDVI time series by “un-projecting” the scores.</p>

<p class="notes">Mathematically, the calculation for this approximation at each time slice,
<script type="math/tex">\mathbf{X_t}</script>, is a linear combination of each score “map”, <script type="math/tex">\bm{T}_i</script>, with
time-varying loadings, <script type="math/tex">\W_{i,t}</script>.</p>

<script type="math/tex; mode=display">\mathbf{X}_t \approx W_{1,t} \mathbf{T}_1 + W_{2,t} \mathbf{T}_2 + W_{3,t} \mathbf{T}_3 + \hdots</script>

<p>The flexible <code class="highlighter-rouge">overlay</code> function allows you to pass a custom function for pixel-wise calculations
on one or more of the main raster objects.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">ndvi_dev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">overlay</span><span class="p">(</span><span class="w">
  </span><span class="n">ndvi_stdz</span><span class="p">,</span><span class="w"> </span><span class="n">ndvi_scores</span><span class="p">,</span><span class="w">
  </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">%*%</span><span class="w"> </span><span class="n">t</span><span class="p">(</span><span class="n">pca</span><span class="o">$</span><span class="n">loadings</span><span class="p">[,</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">npc</span><span class="p">])</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'results/ndvi_dev.grd'</span><span class="p">,</span><span class="w">
  </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi_dev</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">ndvi</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Verify that the deviations just calculated are never very large, then try the
same approximation using even fewer principal components.</p>

<div class="language-r input highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">animate</span><span class="p">(</span><span class="n">ndvi_dev</span><span class="p">,</span><span class="w"> </span><span class="n">pause</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/ndvi_dev_animation.gif" alt="plot of ndvi_dev_animation" /></p>

<p>Based on the time variation in the loadings for principal components 2 and 3, we
might guess that they correspond to one longer-term and one shorter-term departure from
the seasonal NDVI variation within this extent.</p>

<div class="language-r text-document highlighter-rouge" title="worksheet-4.R"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="w">
  </span><span class="n">ndvi_scores</span><span class="p">[[</span><span class="m">2</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-2</span><span class="w"> </span><span class="o">|</span><span class="w">
  </span><span class="n">ndvi_scores</span><span class="p">[[</span><span class="m">3</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-2</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_geometry</span><span class="p">(</span><span class="n">scar</span><span class="p">),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p class="captioned"><img src="/raster-time-series-alaska-lesson/images/pca/unnamed-chunk-12-1.png" alt="plot of chunk unnamed-chunk-12" /></p>

<p class="ToS"><a href="#/slides/pca">Top of Section</a></p>

<hr />

<p><a name="/slides/conclude"></a></p>

<h2 id="summary">Summary</h2>

<p>The <code class="highlighter-rouge">RasterBrick</code> objects created by the <code class="highlighter-rouge">brick</code> function, or sometimes as the
result of calculations on a <code class="highlighter-rouge">RasterStack</code>, are built for many layers of large
rasters. Key principals for efficient analysis on raster time series include</p>

<ul>
  <li>consolidate <code class="highlighter-rouge">RasterStacks</code> to <code class="highlighter-rouge">RasterBricks</code> for faster computation</li>
  <li>provide <code class="highlighter-rouge">filename</code> arguments to keep objects on disk</li>
  <li>use <code class="highlighter-rouge">layerStats</code> to get a covariance matrix for PCA</li>
  <li>use <code class="highlighter-rouge">calc</code> and <code class="highlighter-rouge">overlay</code> to call custom functions</li>
</ul>

<p class="ToS"><a href="#/slides/conclude">Top of Section</a></p>

<hr />



      </div>
    </div>
  <script>
 var collection = document.getElementsByClassName('rlib');
 for (var i = 0; i < collection.length; i++) {
     var a = collection[i];
     a.href = 'https://cran.r-project.org/package=' + a.innerText;
 };
 var collection = document.getElementsByClassName('pylib');
 for (var i = 0; i < collection.length; i++) {
     var a = collection[i];
     a.href = 'https://pypi.python.org/pypi/' + a.innerText;
 };
</script>

  </body>
</html>
